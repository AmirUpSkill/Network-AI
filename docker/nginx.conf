events {
    worker_connections 1024;
}

http {
    server_tokens off;

    #----  Backend services running on HOST machine (uvicorn --host 0.0.0.0) ----
    upstream search_backend {
        server host.docker.internal:8001;
    }

    upstream resume_backend {
        server host.docker.internal:8002;
    }

    server {
        listen 8000;
        server_name localhost;

        # --- Public health check ---
        location = /health {
            add_header Content-Type application/json;
            return 200 '{"gateway":"healthy"}';
        }

        # ---- Route: /v1/search/linkedin → /search/linkedin on search-service ----
        location /v1/search/ {
            proxy_pass http://search_backend/search/;  
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Authorization $http_authorization; 
            proxy_pass_header Authorization;
        }

        # ---- Route: /v1/resume/upload → /resume/upload on resume-service ----
        location /v1/resume/ {
            proxy_pass http://resume_backend/resume/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Authorization $http_authorization;
            proxy_pass_header Authorization;
        }

        # ---  Catch-all ---
        location / {
            add_header Content-Type application/json;
            return 404 '{"error":"Not Found"}';
        }
    }
}